{% extends "base.html" %} 
{% block title %}Начало | 3D Print Studio{% endblock%} 
{% block content %} 

<!-- Hero Section -->
<section id="hero" class="bg-white dark:bg-gray-900 py-20">
  <div class="container mx-auto px-4 text-center">
    <h1 class="text-4xl md:text-5xl font-bold mb-6">
      Вашата идея.
      <span class="text-indigo-600 dark:text-indigo-400">Нашият 3D принт.</span>
    </h1>
    <p class="text-lg mb-8">
      Персонализирани решения за 3D принтиране и дизайн.
    </p>
    <a
      href="#services"
      class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition"
    >
      Виж нашите услуги
    </a>
  </div>
</section>

<!-- Services Section -->
<section id="services" class="bg-gray-50 dark:bg-gray-800 py-16">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-semibold text-center mb-12">Нашите услуги</h2>
    <div class="grid md:grid-cols-3 gap-8 text-center">
      <!-- 3D Моделиране -->
      <div
        class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow transform transition duration-500 hover:scale-105 opacity-0 animate-fade-in-up delay-100"
      >
        <div class="flex justify-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-10 w-10 text-indigo-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 7l-8-4-8 4v6l8 4 8-4V7z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 7l8 4 8-4"
            />
          </svg>
        </div>
        <h3 class="text-xl font-bold mb-2">3D Моделиране</h3>
        <p>Създаваме 3D модели по ваша идея или чертеж.</p>
      </div>

      <!-- 3D Принтиране -->
      <div
        class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow transform transition duration-500 hover:scale-105 opacity-0 animate-fade-in-up delay-200"
      >
        <div class="flex justify-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-10 w-10 text-indigo-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M4 12h16M12 4v8m0 0l3-3m-3 3L9 9"
            />
          </svg>
        </div>
        <h3 class="text-xl font-bold mb-2">3D Принтиране</h3>
        <p>Принтираме с висока прецизност и качествени материали.</p>
      </div>

      <!-- Консултации -->
      <div
        class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow transform transition duration-500 hover:scale-105 opacity-0 animate-fade-in-up delay-300"
      >
        <div class="flex justify-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-10 w-10 text-indigo-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 10V3L4 14h7v7l9-11h-7z"
            />
          </svg>
        </div>
        <h3 class="text-xl font-bold mb-2">Консултации</h3>
        <p>Помагаме с избор на технологии, материали и дизайн.</p>
      </div>
    </div>
  </div>
</section>

<style>
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield;
  }

  #cart-count {
    display: none !important;
  }
</style>

<section id="products" class="py-16 bg-white dark:bg-gray-900">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-semibold text-center mb-12">Избрани продукти</h2>

    {% comment %} <div class="grid md:grid-cols-3 gap-6"> {% endcomment %}
      <div class="grid sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-6">
      {% for product in featured_products %}
      {% include "products/product_detail.html" with product=product %}
      {% endfor %}
    </div>
  </div>
</section>

{% if messages %}
  <div id="toast-wrapper" class="fixed bottom-6 right-6 z-50 space-y-2">
    {% for message in messages %}
      <div
        class="toast bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-lg shadow transition-all duration-500"
      >
        {{ message }}
      </div>
    {% endfor %}
  </div>

  <script>
    setTimeout(() => {
      const toast = document.getElementById("toast-wrapper");
      if (toast) {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
      }
    }, 5000);
  </script>
{% endif %}

<!-- Contact Section -->
<section id="contact" class="bg-white dark:bg-gray-900 py-16">
  <div class="container mx-auto px-4 max-w-2xl">
    <h2 class="text-3xl font-semibold text-center mb-8">Свържи се с нас</h2>
    <form method="post" class="space-y-4">
      {% csrf_token %} {{ form.non_field_errors }}

      <input
        type="text"
        name="name"
        placeholder="Вашето име"
        value="{{ form.name.value|default_if_none:'' }}"
        class="w-full border rounded-xl px-4 py-3 dark:bg-gray-800"
        required
      />
      {% if form.name.errors %}
      <p class="text-sm text-red-600">{{ form.name.errors.0 }}</p>
      {% endif %}

      <input
        type="email"
        name="email"
        placeholder="Имейл"
        value="{{ form.email.value|default_if_none:'' }}"
        class="w-full border rounded-xl px-4 py-3 dark:bg-gray-800"
        required
      />
      {% if form.email.errors %}
      <p class="text-sm text-red-600">{{ form.email.errors.0 }}</p>
      {% endif %}

      <textarea
        name="message"
        rows="4"
        placeholder="Съобщение"
        class="w-full border rounded-xl px-4 py-3 dark:bg-gray-800"
        required
      >
{{ form.message.value|default_if_none:'' }}</textarea
      >
      {% if form.message.errors %}
      <p class="text-sm text-red-600">{{ form.message.errors.0 }}</p>
      {% endif %}

      <div class="flex justify-center">
        <button
          type="submit"
          class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition"
        >
          Изпрати съобщение
        </button>
      </div>
    </form>

  </div>
</section>

<script>
  // Увеличаване/намаляване на количество
  function increaseQty(id) {
    const input = document.getElementById(id);
    input.value = parseInt(input.value || 1) + 1;
  }

  function decreaseQty(id) {
    const input = document.getElementById(id);
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  }

  // Отваряне на продукт модал
  function openModal(id) {
    const modal = document.getElementById(`modal-${id}`);
    const content = document.getElementById(`modal-content-${id}`);
    if (!modal || !content) return;

    modal.classList.remove("hidden");
    modal.classList.add("flex");

    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

    document.body.classList.add("overflow-hidden");

    // ESC за затваряне
    function handleEsc(e) {
      if (e.key === "Escape") {
        closeModal(id);
        document.removeEventListener("keydown", handleEsc);
      }
    }
    document.addEventListener("keydown", handleEsc);
  }

  // Затваряне на продукт модал
  function closeModal(id) {
    const modal = document.getElementById(`modal-${id}`);
    const content = document.getElementById(`modal-content-${id}`);
    if (!modal || !content) return;

    content.classList.remove("scale-100", "opacity-100");
    content.classList.add("scale-95", "opacity-0");

    setTimeout(() => {
      modal.classList.remove("flex");
      modal.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }, 300);
  }

  // Изпращане на форма за количка
  async function submitCartForm(e, form) {
    e.preventDefault();

    const url = form.action;
    const formData = new FormData(form);

    // Намираме изображението за анимация
    let image = form.closest(".p-4")?.previousElementSibling?.querySelector("img");
    if (!image) {
      image = form.closest(".flex-1")?.previousElementSibling?.querySelector("img");
    }
    flyToCart(image);

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      },
      body: formData
    });

    if (response.ok) {
      const data = await response.json();
      showToast("Продуктът е добавен в количката!");
      if (data.cart_count !== undefined) {
        updateCartCount(data.cart_count);
      }
    } else {
      showToast("❌ Грешка при добавяне!");
    }

    return false;
  }

  // Летяща анимация
  function flyToCart(imgElement) {
    if (!imgElement) return;
    const cartIcon = document.getElementById("cart-icon");
    if (!cartIcon) return;

    const imgRect = imgElement.getBoundingClientRect();
    const cartRect = cartIcon.getBoundingClientRect();

    const flyingImg = imgElement.cloneNode(true);
    flyingImg.classList.add("flying-img");
    flyingImg.style.position = "fixed";
    flyingImg.style.top = imgRect.top + "px";
    flyingImg.style.left = imgRect.left + "px";
    flyingImg.style.width = imgRect.width + "px";
    flyingImg.style.height = imgRect.height + "px";
    flyingImg.style.transition = "transform 0.7s ease-in-out, opacity 0.7s ease-in-out";
    flyingImg.style.zIndex = "1000";
    flyingImg.style.pointerEvents = "none";

    document.body.appendChild(flyingImg);

    requestAnimationFrame(() => {
      flyingImg.style.transform = `translate(${cartRect.left - imgRect.left}px, ${cartRect.top - imgRect.top}px) scale(0.1)`;
      flyingImg.style.opacity = "0";
    });

    setTimeout(() => flyingImg.remove(), 700);
  }

  // Toast известие
  function showToast(message) {
    let toast = document.getElementById("toast");
    if (!toast) {
      toast = document.createElement("div");
      toast.id = "toast";
      toast.className = "fixed top-[80px] right-6 z-50 hidden bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 opacity-0 scale-95 transition-all duration-300";
      toast.innerHTML = `
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span id="toast-message" class="font-medium">Продуктът е добавен!</span>
        <button onclick="hideToast()" class="ml-auto text-xl font-bold text-white hover:text-gray-200">&times;</button>
      `;
      document.body.appendChild(toast);
    }

    document.getElementById("toast-message").innerText = message;
    toast.classList.remove("hidden", "opacity-0", "scale-95");
    toast.classList.add("opacity-100", "scale-100");

    setTimeout(() => hideToast(), 5000);
  }

  function hideToast() {
    const toast = document.getElementById("toast");
    toast.classList.remove("opacity-100", "scale-100");
    toast.classList.add("opacity-0", "scale-95");
    setTimeout(() => toast.classList.add("hidden"), 300);
  }

  // Обновяване броя в иконата на количката
  function updateCartCount(count) {
    const cartCount = document.getElementById("cart-count");
    if (cartCount) {
      cartCount.innerText = count;
      cartCount.classList.remove("hidden");
    }

    const modal = document.getElementById("cart-modal");
    if (modal?.classList.contains("flex")) {
      fetch('{% url "cart:cart_detail" %}', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(res => res.text())
      .then(html => {
        document.getElementById('cart-content').innerHTML = html;
      });
    }
  }
    function prevImage(productId) {
      const imgs = window.productImages[productId];
      let index = window.currentImageIndex[productId];
  
      index = (index - 1 + imgs.length) % imgs.length;
      window.currentImageIndex[productId] = index;
  
      const imgEl = document.getElementById(`product-image-${productId}`);
      imgEl.src = imgs[index];
    }
  
    function nextImage(productId) {
      const imgs = window.productImages[productId];
      let index = window.currentImageIndex[productId];
  
      index = (index + 1) % imgs.length;
      window.currentImageIndex[productId] = index;
  
      const imgEl = document.getElementById(`product-image-${productId}`);
      imgEl.src = imgs[index];
    }
  
    function openLightbox(url) {

    }

  
</script>


{% endblock %}
